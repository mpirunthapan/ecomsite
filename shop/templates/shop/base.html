{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}EcomSite{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.min.js" integrity="sha384-7qAoOXltbVP82dhxHAUje59V5r2YsVfBafyUDxEdApLPmcdhBPg1DKg1ERo0BZlK" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="{% static 'shop/style.css' %}">
</head>
<body>
    <main class="container my-4">

        <div class="row">
            <div class="col-md-12">
                <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <a class="navbar-brand" href="#">Navbar</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav">
                    <li class="nav-item active">
                        <a class="nav-link" href="#">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Features</a>
                    </li>
                    <li class="nav-item">
                        <button id="cart" type="button" data-html="true" class="btn btn-secondary" data-bs-container="body" data-bs-toggle="popover" data-bs-placement="bottom" data-bs-content="Cart is empty">
                        Cart(0)
                        </button>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link disabled" href="#">Disabled</a>
                    </li>
                    </ul>
                </div>
                </nav>
            </div>
        </div>

        {% block content %}
        {% endblock %}
    </main>

    <footer class="bg-dark text-white text-center py-3 mt-auto">
        <p class="mb-0">&copy; {{ year }} EcomSite. All rights reserved.</p>
    </footer>

</body>

<script>
document.addEventListener("DOMContentLoaded", function () {
    console.log("Page loaded successfully.");

    // Load cart from localStorage
    let cart = {};
    if (localStorage.getItem('cart') !== null) {
        cart = JSON.parse(localStorage.getItem('cart'));
    }

    const cartButton = document.getElementById('cart');

    // Initialize Bootstrap popover (Bootstrap 5 API, no jQuery)
    const cartPopover = new bootstrap.Popover(cartButton, {
        placement: "bottom", // change to top/left/right if needed
        html: true,
        content: "<p class='text-muted'>Your cart is empty.</p>"
    });

    // Function to refresh popover content
    function updateCartPopover() {
        if (Object.keys(cart).length === 0) {
            cartPopover.setContent({ '.popover-body': "Your cart is empty." });
        } else {
            let content = "<ul class='list-group'>";
            for (const [id, item] of Object.entries(cart)) {
                content += `<li class='list-group-item'>${item.name} Ã— ${item.qty}</li>`;
            }
            content += "</ul>";
            cartPopover.setContent({ '.popover-body': content });
        }

        // Update button count
        let totalQty = Object.values(cart).reduce((a, b) => a + b.qty, 0);
        cartButton.innerText = `Cart(${totalQty})`;
    }

    // Click handler for "Add to Cart"
    document.querySelectorAll(".atc").forEach(btn => {
        btn.addEventListener("click", function () {
            const product_id = this.id.toString();
            const product_name = document.getElementById("nm" + product_id).innerText;
            console.log(product_name);
            let price = parseFloat(document.getElementById("price" + product_id).innerText.replace('$', ''));

            console.log("Add to cart button clicked.", product_id);

            if (cart[product_id] !== undefined) {
                cart[product_id].qty += 1;
                cart[product_id].price += price;
            } else {
                cart[product_id] = { name: product_name, qty: 1, price: price };
            }

            localStorage.setItem('cart', JSON.stringify(cart));
            console.log(cart);
            document.getElementById('cart').innerHTML = "Cart(" + Object.keys(cart).length + ")";
            DisplayCart(cart);

            function DisplayCart(cart) {
                let cartString = "<h5>Your Cart</h5>";
                let cartIndex = 1;

                for (let x in cart) {
                    cartString += `<p>${cartIndex}. ${cart[x].name} - ${cart[x].qty} pcs - $${cart[x].price}</p><br>`;
                    cartIndex += 1;
                }

                cartString += "<hr><a href='/checkout'><button class='btn btn-warning btn-sm'>Checkout</button></a>";

                let cartBtn = document.getElementById('cart');
                cartBtn.setAttribute('data-bs-content', cartString);

                //Refresh popover content
                if (bootstrap.Popover.getInstance(cartBtn)) {
                    bootstrap.Popover.getInstance(cartBtn).dispose();
                }
                new bootstrap.Popover(cartBtn, {
                    placement: "bottom",
                    html: true,
                });
            }

            updateCartPopover();
        });
    });

    // Initialize cart view
    updateCartPopover();
});
</script>

</html>